version: 2
models:
  - name: sales_dashboard
    meta:
      joins:
        - join: calendar
          sql_on: ${calendar.date} = ${sales_dashboard.date}
        - join: dim__branches
          sql_on: |
            ${dim__branches.branch_id} = ${sales_dashboard.branch_id}
        - join: fct__working_days
          sql_on: |
            ${fct__working_days.branch_id} = ${sales_dashboard.branch_id}
            AND ${fct__working_days.date} = ${sales_dashboard.date}
    data_tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - branch_id
            - date
    columns:
      - name: val_transaction_id
        data_type: int64
        description: số lượng giao dịch
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_num_transactions:
              type: sum
              label: No. Transactions
              group_label: Sales metrics
              round: 0
      - name: num_invoice_transaction_id
        data_type: int64
        description: số lượng invoice
        meta:
          dimension:
            type: number
            hidden: true
      - name: num_return_transaction_id
        data_type: int64
        description: số lượng trả
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_num_returns:
              type: sum
              label: No. Returns
              group_label: Sales metrics
              round: 0
            m_return_rate:
              type: number
              sql: safe_divide(${m_num_returns},${m_num_transactions})
              label: Return Rate
              group_label: Sales metrics
              format: percent
              round: 1
      - name: val_total
        data_type: float64
        description: giá trị giao dịch
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_transaction_val:
              type: sum
              label: Transaction Value
              group_label: Sales metrics
              compact: millions
              round: 1
      - name: num_invoice_total
        data_type: float64
        description: giá trị bán
        meta:
          dimension:
            type: number
            hidden: true
      - name: num_return_total
        data_type: float64
        description: giá trị trả
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_return_val:
              type: sum
              label: Return Value
              group_label: Sales metrics
              compact: millions
              round: 1
      - name: val_total_payment
        data_type: float64
        description: doanh thu thuần
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_payment_val:
              type: sum
              label: Payment
              group_label: Sales metrics
              compact: millions
              round: 1
            m_run_rate:
              label: Sales Run rate
              group_label: Sales metrics
              type: number
              sql: safe_divide(${m_payment_val},${m_sales_target})
              format: percent
              round: 2
            m_payment_psd:
              label: Revenue PSD
              group_label: Sales metrics
              type: number
              sql: safe_divide(${m_payment_val},${m_num_stores})
              compact: millions
              round: 2
      - name: num_invoice_total_payment
        data_type: float64
        description: doanh thu thuần bán hàng
        meta:
          dimension:
            type: number
            hidden: true
      - name: num_return_total_payment
        data_type: float64
        description: doanh thu thuần trả hàng
        meta:
          dimension:
            type: number
            hidden: true
      - name: daily_budget
        data_type: float64
        description: ngân sach/ngày
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_ads_budget:
              type: sum
              label: Budget
              group_label: Budget
              compact: millions
              round: 1
      - name: daily_sales_target
        data_type: float64
        description: target sales/ngày
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_sales_target:
              type: sum
              label: Sales target
              group_label: Budget
              compact: millions
              round: 1
      - name: daily_traffic_target
        data_type: float64
        description: target traffic/ngày
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_traffic_target:
              type: sum
              label: Traffic target
              group_label: Budget
              round: 0
      - name: date
        description: Ngày
        meta:
          dimension:
            type: date
            hidden: true
      - name: branch_id
        description: Mã CH
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_num_operating_days:
              type: count_distinct
              sql: ${TABLE}.date||${TABLE}.branch_id
              label: No. Operating Days
              group_label: Misc
              round: 0
      - name: num_stores
        description: ""
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_num_stores:
              type: sum
              label: No. Days with Revenue
              group_label: Misc
              round: 0
      - name: total_traffic
        description: ""
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_total_traffic:
              type: sum
              label: Total Traffic
              group_label: Traffic
              round: 0
            m_traffic_run_rate:
              type: number
              sql: safe_divide(${m_total_traffic},${m_traffic_target})
              format: percent
              label: Traffic Run rate
              group_label: Traffic
              round: 2
            m_traffic_psd:
              label: Traffic PSD
              group_label: Sales metrics
              type: number
              sql: safe_divide(${m_total_traffic},${m_num_stores})
              round: 2
      - name: total_working_hour
        description: ""
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_total_working_hour:
              type: sum
              label: Total Working Hour
              group_label: Traffic
              round: 0
      - name: val_customer_id
        description: ""
        meta:
          dimension:
            type: number
            hidden: true
      - name: num_invoice_customer_id
        description: ""
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_num_customers:
              type: sum
              label: No. Customers Purchased
              group_label: Sales metrics
              round: 0
      - name: num_return_customer_id
        description: ""
        meta:
          dimension:
            type: number
            hidden: true
      - name: promotion
        description: ""
        meta:
          dimension:
            type: string
            hidden: true
      - name: num_invoices
        description: ""
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_num_invoices:
              type: sum
              label: No. Invoices
              group_label: Sales metrics
              round: 0
            m_num_invoices_psd:
              type: number
              label: No. Invoices PSD
              group_label: Sales metrics
              sql: safe_divide(${m_num_invoices},${m_num_stores})
              round: 2
            m_aov:
              type: number
              sql: safe_divide(${m_transaction_val},${m_num_invoices})
              label: AOV
              group_label: Sales metrics
              compact: thousands
              round: 1
            m_revenue_per_customer:
              type: number
              sql: safe_divide(${m_transaction_val},${m_num_customers})
              label: Revenue per Customer
              group_label: Sales metrics
              compact: thousands
              round: 1
            m_conversion_rate:
              type: number
              sql: safe_divide(${m_num_invoices},${m_total_traffic})
              format: percent
              label: Conversion Rate
              round: 2
      - name: invoice_value
        description: ""
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_invoice_val:
              type: sum
              label: Invoice Value
              group_label: Sales metrics
              compact: millions
              round: 1
      - name: val_gross_margin
        description: ""
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_gross_margin_target:
              type: average
              label: Gross Margin target
              format: percent
              round: 2
              group_label: Budget
      - name: val_upt
        description: ""
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_upt_target:
              type: average
              label: UPT target
              round: 2
              group_label: Budget
      - name: val_ausp
        description: ""
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_ausp_target:
              type: average
              label: AUSP target
              round: 1
              compact: thousands
              group_label: Budget
      - name: val_aov
        description: ""
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_aov_target:
                type: average
                label: AOV target
                round: 1
                group_label: Budget
                compact: thousands
      - name: val_cr
        description: ""
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_cr_target:
              type: average
              label: CVR target
              round: 2
              format: percent
              group_label: Budget
      - name: units_sold
        description: ""
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_units_sold:
              type: sum
              label: Total Units Sold
              group_label: Sales metrics
              round: 0
            m_upt:
              type: number
              sql: safe_divide(${m_units_sold},${m_num_invoices})
              label: UPT
              group_label: Sales metrics
              round: 2
            m_ausp:
              type: number
              sql: safe_divide(${m_transaction_val},${m_units_sold})
              label: AUSP
              group_label: Sales metrics
              compact: thousands
              round: 1
      - name: total_cogs
        description: ""
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_total_cogs:
              type: sum
              label: Total COGS
              group_label: Sales metrics
              round: 2
              compact: millions
            m_gross_margin:
              type: number
              sql: safe_divide(${m_transaction_val}-${m_total_cogs},${m_transaction_val})
              label: Gross Margin
              group_label: Sales metrics
              format: percent
              round: 2
            m_gross_profit:
              type: number
              sql: ${m_transaction_val}-${m_total_cogs}
              label: Gross Profit
              group_label: Sales metrics
              format: percent
              round: 2
      - name: order_discount
        description: ""
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_order_discount:
              type: sum
              label: Total Order Discount
              group_label: Sales metrics
              round: 2
              compact: millions
    description: >-
      The sales_dashboard model combines offline sales performance data with
      budget data to provide a comprehensive view of branch-level sales
      performance.
