version: 2
models:
  - name: facebook_performance
    description: ""
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - date_start
            - ad_key
    meta:
      joins:
        - join: calendar
          sql_on: ${facebook_performance.date_start} = ${calendar.date}
        - join: dim__campaigns
          sql_on: ${dim__campaigns.ad_key} = ${facebook_performance.ad_key}
          always: true
        - join: dim__ad_accounts
          sql_on: >-
            ${dim__ad_accounts.id} =
            ${dim__campaigns.account_id}
        - join: dim__pages
          sql_on: ${dim__pages.page_id} = ${dim__campaigns.ad_page_id}
        - join: dim__contents
          sql_on: ${dim__contents.content_code} = ${dim__campaigns.content_code}
    columns:
      - name: date_start
        description: ""
        meta:
          dimension:
            type: date
            hidden: true
      - name: impressions
        description: ""
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_impressions:
              type: sum
              label: Impressions
              group_label: FB Ads
              compact: thousands
              round: 1
            m_avg_impressions:
              type: average
              label: AVG Impressions
              group_label: FB Ads
              compact: millions
              round: 1
            m_cpm:
              type: number
              label: CPM
              group_label: FB Ads
              sql: safe_divide(${m_spend},${m_impressions}) * 1000
              compact: thousands
              round: 1
      - name: spend
        description: ""
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_spend:
              type: sum
              label: Spend
              group_label: FB Ads
              compact: millions
              round: 2
            m_avg_spend:
              type: average
              label: Avg Spend
              group_label: FB Ads
              compact: millions
              round: 1
            m_ads_purchased:
              type: number
              label: Ads Purchased
              sql: ifnull(${m_ocv},0) + ifnull(${m_pcv},0) + ifnull(${m_meta_purchase},0)
              group_label: FB Ads
              round: 0
            m_ads_purchased_value:
              type: number
              label: Ads Purchased Value
              sql: ifnull(${m_ocv_value},0) + ifnull(${m_pcv_value},0) + ifnull(${m_meta_purchase_value},0)
              group_label: FB Ads
              round: 1
              compact: millions
            m_ads_roas:
              type: number
              label: Ads ROAS
              sql: safe_divide(${m_ads_purchased_value},${m_spend})
              group_label: FB Ads
              round: 2
            m_ads_aov:
              type: number
              label: Ads AOV
              sql: safe_divide(${m_ads_purchased_value},${m_ads_purchased})
              group_label: FB Ads
              round: 1
              compact: thousands
            m_ads_cost_per_purchase:
              type: number
              label: Ads Cost per Purchase
              sql: safe_divide(${m_spend},${m_ads_purchased})
              group_label: FB Ads
              round: 1
              compact: thousands
            m_ads_cost_over_value:
              type: number
              label: Ads Cost over Value
              sql: safe_divide(${m_spend},${m_ads_purchased_value})
              group_label: FB Ads
              round: 2
              format: percent
      - name: clicks
        description: ""
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_clicks:
              type: sum
              label: Clicks
              group_label: FB Ads
              compact: thousands
              round: 1
            m_cpc:
              type: number
              label: CPC
              group_label: FB Ads
              sql: safe_divide(${m_spend},${m_clicks})
              compact: thousands
              round: 1
            m_ctr:
              type: number
              label: CTR
              group_label: FB Ads
              sql: safe_divide(${m_clicks},${m_impressions})
              format: percent
              round: 2
      - name: reach
        description: ""
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_reach:
              type: average
              label: Reach
              group_label: FB Ads
              compact: thousands
              round: 1
      - name: link_click
        description: number of clicks to any urls in ads
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_link_click:
              type: sum
              label: Link Clicks
              group_label: FB Ads
              compact: thousands
              round: 1
            m_cpl:
              type: number
              label: Cost per Link click
              group_label: FB Ads
              sql: safe_divide(${m_spend},${m_link_click})
              compact: thousands
              round: 1
            m_ctr_link_click:
              type: number
              label: CTR Link Click
              group_label: FB Ads
              sql: safe_divide(${m_link_click},${m_impressions})
              format: percent
              round: 1
      - name: post_engagement
        description: number of engagement with ad post
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_post_engagement:
              type: sum
              label: Post engagement
              group_label: FB Ads
              compact: thousands
              round: 1
            m_cost_per_engagement:
              type: number
              label: Cost per engagement
              group_label: FB Ads
              sql: safe_divide(${m_spend},${m_post_engagement})
              compact: thousands
              round: 1
      - name: offline_conversion_purchase
        description: number of offline purchases attributed to ads
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_ocv:
              type: sum
              label: Offine CV Purchase
              group_label: FB Ads
              compact: thousands
              round: 1
      - name: offline_conversion_purchase_value
        description: offline purchase value attributed to ads
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_ocv_value:
              type: sum
              label: Offline CV Value
              group_label: FB Ads
              compact: millions
              round: 1
            m_ocv_aov:
              type: number
              label: Offline AOV
              group_label: FB Ads
              sql: safe_divide(${m_ocv_value},${m_ocv})
              compact: thousands
              round: 1
      - name: pixel_purchase
        description: website purchase attributed to ads
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_pcv:
              type: sum
              label: Online CV
              group_label: FB Ads
              compact: thousands
              round: 1
      - name: pixel_purchase_value
        description: website purchase value attributed to ads
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_pcv_value:
              type: sum
              label: Online CV Value
              group_label: FB Ads
              compact: millions
              round: 1
            m_pcv_aov:
              type: number
              label: Online AOV
              group_label: FB Ads
              sql: safe_divide(${m_pcv_value},${m_pcv})
              compact: thousands
              round: 1
      - name: meta_purchase
        description: number of purchase generated directly on facebook
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_meta_purchase:
              type: sum
              label: Message CV
              group_label: FB Ads
              round: 0
      - name: meta_purchase_value
        description: purchase value generated directly on facebook
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_meta_purchase_value:
              type: sum
              label: Message CV Value
              group_label: FB Ads
              compact: millions
              round: 1
            m_meta_purchase_aov:
              type: number
              label: Message AOV
              group_label: FB Ads
              sql: safe_divide(${m_meta_purchase_value},${m_meta_purchase})
              compact: thousands
              round: 1
            m_meta_purchase_roas:
              type: number
              label: Message ROAS
              group_label: FB Ads
              sql: safe_divide(${m_meta_purchase_value},${m_spend})
              round: 2
      - name: _results_message
        description: ""
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_messages:
              type: sum
              label: Messages
              group_label: FB Ads
              round: 0
            m_cost_per_message:
              type: number
              label: Cost per message
              group_label: FB Ads
              sql: safe_divide(${m_spend},${m_messages})
              compact: thousands
              round: 1
            m_message_cr:
              type: number
              label: Message CR
              group_label: FB Ads
              sql: safe_divide(${m_meta_purchase},${m_messages})
              format: percent
              round: 2
            
      - name: account_id
        description: ""
        meta:
          dimension:
            type: number
            hidden: true
      - name: ad_key
        description: ""
        meta:
          dimension:
            type: string
            hidden: true
