version: 2
models:
  - name: conversations_engaged
    meta:
      joins:
        - join: stg_pancake__customers
          sql_on: ${conversations_engaged.customer_id} =
            ${stg_pancake__customers.customer_id}
          fields:
            - customer_id
            - city
            - gender
            - inserted_at
        - join: stg_pancake__pages
          sql_on: ${stg_pancake__pages.page_id} = ${conversations_engaged.page_id}
          fields:
            - page_id
            - page_name
        - join: stg_pancake__posts
          sql_on: ${stg_pancake__posts.post_id} = ${conversations_engaged.post_id}
          fields:
            - post_id
            - post_title
        - join: stg_pancake__users
          sql_on: ${stg_pancake__users.user_id} = ${conversations_engaged.user_id}
          fields:
            - user_id
            - user_name
        - join: calendar
          sql_on: ${calendar.date} = date(${conversations_engaged.inserted_at})
        - join: calendar
          alias: ad_calendar
          sql_on: ${ad_calendar.date} = date(${conversations_engaged.ad_inserted_at})
        - join: dim__campaigns
          sql_on: ${dim__campaigns.ad_id} = ${conversations_engaged.ad_id}
    columns:
      - name: inserted_at
        meta:
          dimension:
            type: timestamp
            hidden: true
          additional_dimensions:
            d_customer_class:
              type: string
              sql: >
                case when ${stg_pancake__customers.inserted_at} <
                ${TABLE}.inserted_at then 'Khách cũ' else 'Khách mới' end
              label: Customer group
        data_type: datetime
      - name: conversation_id
        meta:
          dimension:
            type: string
            hidden: true
          metrics:
            m_num_conversations:
              type: count_distinct
              label: No. conversations
              group_label: Pancake metrics
              round: 0
        data_type: string
      - name: customer_id
        meta:
          dimension:
            type: string
            hidden: true
          metrics:
            m_num_customer_engaged:
              type: count_distinct
              label: No. Engaged Customers
              group_label: Pancake metrics
              compact: thousands
              round: 1
        data_type: string
      - name: user_id
        meta:
          dimension:
            type: string
            hidden: true
        data_type: string
      - name: page_id
        meta:
          dimension:
            type: string
            hidden: true
        data_type: string
      - name: post_id
        meta:
          dimension:
            type: string
            hidden: true
        data_type: string
      - name: message_count
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_num_messages:
              type: sum
              label: No. Messages
              group_label: Pancake metrics
              compact: thousands
              round: 1
            m_avg_messages_per_convo:
              type: number
              label: Avg. Messages per conversation
              group_label: Pancake metrics
              sql: safe_divide(${m_num_messages},${m_num_conversations})
              round: 1
        data_type: numeric
      - name: snippet
        meta:
          dimension:
            type: string
            hidden: true
        data_type: string
      - name: type
        meta:
          dimension:
            type: string
        data_type: string
      - name: ads_assisted
        meta:
          dimension:
            type: string
        data_type: string
      - name: agent
        meta:
          dimension:
            type: string
        data_type: string
      - name: conversation_type
        meta:
          dimension:
            type: string
            hidden: true
          additional_dimensions:
            d_conversation_type:
              type: string
              label: Conversation type
              sql: coalesce(${TABLE}.conversation_type,"Mua hàng")
        data_type: string
      - name: promotion_type
        meta:
          dimension:
            type: string
        data_type: string
      - name: customer_type
        meta:
          dimension:
            type: string
        data_type: string
      - name: stage
        meta:
          dimension:
            type: string
            label: Tag value
          additional_dimensions:
            d_stage:
              type: string
              sql: >
                case when lower(${TABLE}.stage) like '%chưa phản hồi%' then '[2]
                Chưa phản hồi' when lower(${TABLE}.stage) like '%tham khảo%'
                then '[3] Tham khảo' when
                regexp_contains(lower(${TABLE}.stage),r'chăm sóc lần') then
                '[3.1] Chăm sóc lại' when
                regexp_contains(lower(${TABLE}.stage),r'đang chổt|đang chốt')
                then '[4] Đang chốt' when
                regexp_contains(lower(${TABLE}.stage),r'chuyển ch|khách ra sr|đã
                mua hàng') then '[5] Chốt đơn' when
                regexp_contains(lower(${TABLE}.stage),r'đã gửi|kiểm hàng') then
                '[0] Đang giao hàng' when
                regexp_contains(lower(${TABLE}.stage),r'giá cao|hết hàng') then
                'Huỷ' else '[1] Hội thoại mới' end
              label: Stage
            d_closed_state:
              type: string
              sql: >
                case  when lower(${TABLE}.stage) like '%đã mua hàng%' then 'Đã
                mua hàng'  when lower(${TABLE}.stage) like '%chuyển ch%' then
                'chuyển CH' when lower(${TABLE}.stage) like '%khách ra sr%' then
                'Khách ra SR' end
              label: Closed State
            d_refuse_reason:
              type: string
              sql: >
                case  when lower(${TABLE}.stage) like '%giá cao%' then 'Giá Cao'
                when lower(${TABLE}.stage) like '%hết hàng%' then 'Hết hàng' end
              label: Refuse Reason
        data_type: string
      - name: claim_status
        meta:
          dimension:
            type: string
        data_type: string
      - name: ad_id
        data_type: string
        quote: true
        meta:
          dimension:
            type: string
            hidden: true
      - name: ad_post_id
        data_type: string
        quote: true
        meta:
          dimension:
            type: string
            hidden: true
      - name: ad_inserted_at
        data_type: datetime
        quote: true
        meta:
          dimension:
            type: timestamp
            hidden: true
