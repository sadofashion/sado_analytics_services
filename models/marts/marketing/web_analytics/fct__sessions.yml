version: 2
models:
  - name: fct__sessions
    meta:
      joins:
        - join: calendar
          sql_on: ${calendar.date} = ${fct__sessions.session_start_date}
        - join: dim__sessions
          sql_on: ${dim__sessions.session_key} = ${fct__sessions.session_key}
        - join: dim__client_keys
          sql_on: ${dim__client_keys.client_key} = ${fct__sessions.client_key}
    columns:
      - name: client_key
        description: ""
        meta:
          dimension:
            type: string
            hidden: true
          metrics:
            m_users:
              type: count_distinct
              label: "# Users"
              group_label: Users
              compact: thousands
              round: 1
            m_new_user:
              type: count_distinct
              label: "# New Users"
              group_label: Users
              filters:
                - session_number: "1"
              compact: thousands
              round: 1
            m_returning_user:
              type: count_distinct
              label: "# Returning Users"
              group_label: Users
              filters:
                - session_number: "!1"
              compact: thousands
              round: 1
            m_engaged_users:
              type: count_distinct
              label: "# Engaged Users"
              group_label: Users
              filters:
                - is_session_engaged: 1
              compact: thousands
              round: 1
            m_user_engagement_rate:
              type: number
              label: User Engagement Rate
              sql: safe_divide(${m_engaged_users}, ${m_users})
              group_label: Users
              format: percent
              round: 1
        data_type: STRING
      - name: session_key
        description: ""
        meta:
          dimension:
            type: string
            hidden: true
          metrics:
            m_sessions:
              type: count_distinct
              label: "# Sessions"
              group_label: Sessions
              compact: thousands
              round: 1
            m_engaged_sessions:
              type: count_distinct
              label: "# Engaged Sessions"
              group_label: Sessions
              filters:
                - is_session_engaged: 1
              compact: thousands
              round: 1
            m_session_engagement_rate:
              type: number
              label: Session Engagement Rate
              sql: safe_divide(${m_engaged_sessions}, ${m_sessions})
              group_label: Sessions
              format: percent
              round: 1
            m_bounced_sessions:
              type: count_distinct
              label: "# Bounced Sessions"
              group_label: Sessions
              filters:
                - is_session_engaged: 0
              compact: thousands
              round: 1
            m_bounce_rate:
              type: number
              label: Bounce Rate
              sql: safe_divide(${m_bounced_sessions}, ${m_sessions})
              group_label: Sessions
              format: percent
              round: 1
        data_type: STRING
      - name: stream_id
        description: ""
        meta:
          dimension:
            type: string
            hidden: true
        data_type: STRING
      - name: user_id
        description: ""
        meta:
          dimension:
            type: string
            hidden: true
        data_type: STRING
      - name: session_start_timestamp
        description: ""
        meta:
          dimension:
            type: number
            hidden: true
        data_type: INT64
      - name: session_start_date
        description: ""
        meta:
          dimension:
            type: date
            hidden: true
        data_type: DATE
      - name: count_pageviews
        description: ""
        meta:
          dimension:
            type: number
          metrics:
            m_pageviews:
              type: sum
              label: "# Page Views"
              group_label: Sessions
              compact: thousands
              round: 1
            m_pageviews_per_session:
              type: number
              label: "# Page Views per Session"
              group_label: Sessions
              sql: safe_divide(${m_pageviews}, ${m_sessions})
              round: 1
        data_type: INT64
      - name: sum_event_value_in_usd
        description: ""
        meta:
          dimension:
            type: number
            hidden: true
        data_type: FLOAT64
      - name: is_session_engaged
        description: ""
        meta:
          dimension:
            type: number
            hidden: true
        data_type: INT64
      - name: sum_engaged_time_msec
        description: ""
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_avg_engaged_time_msec:
              type: average
              label: Avg Engaged Time (sec)
              sql: safe_divide(${sum_engaged_time_msec}, 1000)
              group_label: Sessions
              round: 1
            m_total_engaged_time_msec:
              type: sum
              label: Total Engaged Time (sec)
              sql: safe_divide(${sum_engaged_time_msec}, 1000)
              group_label: Sessions
              round: 0
            m_total_engaged_time_msec_per_user:
              type: number
              label: Total Engaged Time (sec) per User
              group_label: Users
              sql: safe_divide(${m_total_engaged_time_msec}, ${m_users})
              round: 1
            m_med_engaged_time_msec:
              type: median
              label: Median Engaged Time (sec)
              sql: safe_divide(${sum_engaged_time_msec}, 1000)
              group_label: Sessions
              round: 0
        data_type: INT64
      - name: session_number
        description: ""
        meta:
          dimension:
            type: number
            hidden: true
          additional_dimensions:
            d_user_type:
              type: string
              sql: case when ${TABLE}.session_number =1 then 'New User' else "Return User" end
              label: User type
            d_session_number:
              type: string
              sql: case when ${TABLE}.session_number >5 then '5+' else cast(${TABLE}.session_number as string) end
              label: Session Num
        data_type: INT64
      - name: count_purchase
        description: ""
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_purchase:
              type: sum
              label: "# Purchases"
              group_label: Sessions
              round: 0
            m_session_conversion_rate:
              type: number
              label: Session Conversion Rate
              group_label: Sessions
              sql: safe_divide(${m_purchase}, ${m_sessions})
              format: percent
              round: 2
            m_user_conversion_rate:
              type: number
              label: User Conversion Rate
              group_label: Users
              sql: safe_divide(${m_purchase}, ${m_users})
              format: percent
              round: 2
        data_type: INT64
      - name: count_message
        description: ""
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_message:
              type: sum
              label: "# Messages"
              group_label: Sessions
              round: 0
        data_type: INT64
      - name: count_call
        description: ""
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_call:
              type: sum
              label: "# Calls"
              group_label: Sessions
              round: 0
        data_type: INT64
      - name: count_generate_lead
        description: ""
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_generate_lead:
              type: sum
              label: "# Generate Lead"
              group_label: Sessions
              round: 0
            m_contacts:
              type: sum
              label: "# Contacts"
              group_label: Sessions
              sql: (${count_generate_lead} + ${count_message} + ${count_call})
              round: 0
        data_type: INT64
      - name: count_store_visit
        description: ""
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_store_visit:
              type: sum
              label: "# Store Visits"
              group_label: Sessions
              round: 0
        data_type: INT64
      - name: count_add_to_cart
        description: ""
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_add_to_cart:
              type: sum
              label: "# Add to Cart"
              group_label: Sessions
              round: 0
    description: ""
