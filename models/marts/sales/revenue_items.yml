version: 2
models:
  - name: revenue_items
    description: ""
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - transaction_id
            - product_id
            - price
    meta:
      joins:
        - join: stg_kiotviet__branches
          sql_on: ${stg_kiotviet__branches.branch_id} = ${revenue_items.branch_id}
          fields: [branch_name,region,province,branch_id]
        
        - join: dim__offline_stores
          sql_on: ${dim__offline_stores.branch_id} = ${revenue_items.branch_id}
          fields:
            - new_ads_page
            - new_ads_pic
            - asm_name
            - branch_name
            - province
            - region

        - join: stg_kiotviet__customers
          sql_on: >-
            ${stg_kiotviet__customers.customer_id} =
            ${revenue_items.customer_id}
          fields: [customer_id, customer_group, customer_type]
        - join: stg_kiotviet__products
          sql_on: ${stg_kiotviet__products.product_id} = ${revenue_items.product_id}
          fields: [product_id,product_name,class_name,sub_productline,product_line,category,ads_product_mapping,product_group]
        - join: stg_kiotviet__users
          sql_on: ${stg_kiotviet__users.user_id} =${revenue_items.employee_id}
          fields: [user_id, user_name]
        - join: calendar
          sql_on: ${calendar.date} = date(revenue_items.transaction_date)
        - join: revenue
          sql_on: ${revenue_items.transaction_id} = ${revenue.transaction_id}
    columns:
      - name: transaction_id
        description: ""
        meta:
          dimension:
            type: number
            hidden: true
      - name: transaction_code
        description: ""
        meta:
          dimension:
            type: string
      - name: reference_transaction_id
        description: ""
        meta:
          dimension:
            type: number
            hidden: true
      - name: transaction_date
        description: ""
        meta:
          dimension:
            type: timestamp
            hidden: true
      - name: transaction_status
        description: ""
        meta:
          dimension:
            type: string
      - name: branch_id
        description: ""
        meta:
          dimension:
            type: number
            hidden: true
      - name: employee_id
        description: ""
        meta:
          dimension:
            type: number
            hidden: true
      - name: customer_id
        description: ""
        meta:
          dimension:
            type: number
            hidden: true
      - name: product_id
        description: ""
        meta:
          dimension:
            type: number
            hidden: true
      - name: product_code
        description: ""
        meta:
          dimension:
            type: string
            hidden: true
      - name: quantity
        description: ""
        meta:
          metrics:
            m_item_sold:
              type: sum
              label: Num Items Sold
              group_label: Sales Metrics
              compact: thousands
              round: 1
              filters:
                - transaction_type: invoice
                - subtotal: "> 0"
            m_item_return:
              type: sum
              label: Num Items Return
              group_label: Sales Metrics
              compact: thousands
              round: 1
              filters:
                - transaction_type: return
          dimension:
            type: number
      - name: price
        description: ""
        meta:
          dimension:
            type: number
      - name: discount_ratio
        description: ""
        meta:
          dimension:
            type: number
      - name: discount
        description: ""
        meta:
          metrics:
            m_item_discount_value:
              type: sum
              label: Value discount on Items
              group_label: Sales Metrics
              filters:
                - transaction_type: invoice
              compact: millions
              round: 1
          dimension:
            type: number
      - name: subtotal
        description: ""
        meta:
          metrics:
            m_item_value:
              type: sum
              label: Item Value
              group_label: Sales Metrics
              compact: billions
              round: 1
              filters:
                - transaction_type: invoice
          dimension:
            type: number
      - name: transaction_type
        description: ""
        meta:
          dimension:
            type: string
