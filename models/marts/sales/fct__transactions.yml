version: 2
models:
  - name: fct__transactions
    description: "The 'fct__transactions' model is a comprehensive view of the
      company's transactions, combining data from two sources: 'kiotviet' and
      'nhanhvn'. The model is designed to provide a holistic view of the
      company's revenue, taking into account both invoices and returns. It is
      particularly useful for business users who need to analyze revenue trends,
      customer behavior, and transaction patterns."
    meta:
      joins:
        - join: calendar
          sql_on: ${calendar.date} = ${fct__transactions.transaction_date}
        - join: dim__branches
          sql_on: ${dim__branches.branch_id} = ${fct__transactions.branch_id}
    columns:
      - name: transaction_id
        description:
          This is a unique identifier for each transaction. It is a large
          numeric value that is automatically generated by the system for each
          transaction. This field is crucial for tracking and auditing purposes.
        meta:
          dimension:
            type: number
            hidden: true
        tests:
          - not_null
        data_type: BIGNUMERIC
      - name: transaction_code
        description:
          This is a unique code associated with each transaction. It is a
          string value that may contain alphanumeric characters. This code is
          often used for referencing transactions in reports and discussions.
        meta:
          dimension:
            type: string
            hidden: true
        data_type: STRING
      - name: transaction_date
        description:
          This is the date when the transaction occurred. It is stored in the
          DATE format. This field is important for financial reporting and
          analysis, as it allows the business to track revenue and sales trends
          over time.
        meta:
          dimension:
            type: date
            hidden: true
        data_type: DATE
      - name: reference_transaction_id
        description:
          This is a unique identifier for the transaction that the current
          transaction is referencing. It is used to link related transactions
          together. For example, if a customer returns an item, the return
          transaction would reference the original purchase transaction.
        meta:
          dimension:
            type: number
            hidden: true
        data_type: NUMERIC
      - name: branch_id
        description:
          This is a unique identifier for the branch where the transaction
          took place. It is used to track the performance of different branches
          and to allocate resources effectively.
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_working_days:
              type: count_distinct
              sql:  (${transaction_date}||${branch_id})
              label: Working Days
              round: 0
              group_label: Working Days
        tests:
          - not_null
        data_type: NUMERIC
      - name: customer_id
        description: This is a unique identifier for the customer who made the
          transaction. It is used to track customer behavior and preferences,
          and to personalize the customer experience.
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_active_customers:
              type: count_distinct
              label: Active Customers
              round: 0
              group_label: Customers
            m_customers_psd:
              type: number
              sql: safe_divide(${m_active_customers},${m_working_days})
              label: Customers per day
              round: 1
              group_label: Customers
            m_revenue_per_customer:
              type: number
              sql: safe_divide(${m_total_payment},${m_active_customers})
              label: Revenue per customer
              round: 1
              compact: thousands
              group_label: Sales Metrics
        data_type: BIGNUMERIC
      - name: employee_id
        description:
          This is the unique identifier for each employee in the company. It
          is used to track the transactions made by each employee.
        meta:
          dimension:
            type: number
            hidden: true
        data_type: BIGNUMERIC
      - name: total
        description:
          This represents the total amount of the transaction after any
          discounts or fees are applied. It is a key metric in understanding the
          company's revenue.
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_total_value:
              type: sum
              compact: millions
              round: 1
              label: Total Booked Revenue
              group_label: Revenue Metrics
            m_total_returned:
              type: sum
              compact: millions
              round: 1
              label: Total Returned
              group_label: Revenue Metrics
              filters:
                - transaction_type: return
            m_total_invoice:
              type: sum
              compact: millions
              round: 1
              label: Total Invoice
              group_label: Revenue Metrics
              filters:
                - transaction_type: invoice
            m_aov:
              label: AOV
              type: average
              group_label: Sales Metrics
              round: 1
              filters:
                - transaction_type: invoice
                - total: ">0"
        data_type: FLOAT64
      - name: total_payment
        description:
          This is the final amount paid by the customer after all discounts
          have been applied and fees added. It is a crucial figure in
          understanding the company's actual earnings from each transaction.
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_total_payment:
              type: sum
              compact: millions
              round: 1
              label: Total Collected Revenue
              group_label: Revenue Metrics
            m_returned_value:
              type: sum
              compact: millions
              round: 1
              label: Returned Value
              group_label: Revenue Metrics
              filters:
                - transaction_type: return
            m_invoice_value:
              type: sum
              compact: millions
              round: 1
              label: Sales Value
              group_label: Revenue Metrics
              filters:
                - transaction_type: invoice
            m_revenue_psd:
              type: number
              sql: safe_divide(${m_total_payment} , ${m_working_days})
              compact: millions
              round: 1
              label: Revenue Per Day
              group_label: Revenue Metrics
            m_online_revenue:
              type: sum
              compact: millions
              round: 1
              label: Online Revenue
              group_label: Revenue Metrics
              filters:
                - dim__branches.channel: 'Online & Ecom'
            m_offline_revenue:
              type: sum
              compact: millions
              round: 1
              label: Offline Revenue
              group_label: Revenue Metrics
              filters:
                - dim__branches.channel: 'Offline'
            m_online_attribution_pct:
              type: number
              format: percent
              round: 2
              label: Online Attribution Pct
              group_label: Revenue Metrics
              sql: safe_divide(${m_online_revenue}, ${m_total_payment})
        data_type: FLOAT64
      - name: discount
        description:
          This column represents the total amount of discount applied to a
          particular transaction. It is calculated based on the discount rules
          set by the company. The value is in the currency of the transaction
          and can be used to understand the company's discount strategy and its
          impact on revenue.
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_total_discount:
              type: sum
              compact: millions
              round: 1
              label: Total Discount
              group_label: Revenue Metrics
              filters:
                - transaction_type: invoice
            m_discount_pct:
              type: number
              sql: safe_divide(${m_total_discount},${m_invoice_value}+${m_total_discount})
              label: Discount Pct
              group_label: Revenue Metrics
              format: percent
              round: 1
        data_type: FLOAT64
      - name: discount_ratio
        description:
          This column represents the ratio of the discount to the total
          transaction amount before the discount was applied. It is calculated
          by dividing the discount by the sum of the discount and the total
          transaction amount. This ratio can be used to understand the
          proportion of the transaction that was discounted and can provide
          insights into the company's discounting practices.
        meta:
          dimension:
            type: number
            hidden: true
        data_type: FLOAT64
      - name: return_fee
        description:
          This column represents the fee charged for returning a product. It
          is calculated based on the company's return policy. This fee is
          usually charged to cover the costs associated with processing the
          return. This can be used to understand the company's return policy and
          its impact on customer satisfaction and revenue.
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_return_fee:
              type: sum
              compact: millions
              round: 1
              label: Return Fee
              group_label: Revenue Metrics
              filters:
                - transaction_type: return
        data_type: NUMERIC
      - name: transaction_type
        description:
          This column represents the type of transaction that has taken
          place. It can either be an 'invoice' which indicates a sale or a
          'return' which indicates a product return by the customer.
        meta:
          dimension:
            type: string
            hidden: true
        data_type: STRING
        tests:
          - accepted_values:
              values:
                - invoice
                - return
      - name: modified_date
        description:
          This column represents the date when the transaction was last
          modified. It helps in tracking the changes made to the transaction
          over time.
        meta:
          dimension:
            type: timestamp
            hidden: true
        data_type: DATE
      - name: source
        description:
          This column indicates the source from where the transaction data
          was fetched. It can either be 'kiotviet' or 'nhanhvn', representing
          the two different systems from which the data is sourced.
        meta:
          dimension:
            type: string
            hidden: true
        data_type: STRING
      - name: transaction_source_id
        description:
          This is a unique identifier for each transaction. It is generated
          by applying the MD5 hash function to the combination of the
          transaction_id and the source of the transaction. This identifier is
          useful for tracking and referencing individual transactions across
          different sources.
        meta:
          dimension:
            type: string
            hidden: true
          metrics:
            m_num_invoices:
              label: No. Invoices
              type: count_distinct
              group_label: Sales Metrics
              round: 0
              filters:
                - transaction_type: invoice
            m_num_invoices_psd:
              type: number
              sql: safe_divide(${m_num_invoices} , ${m_working_days})
              round: 0
              label: No. Invoices Per Day
              group_label: Sales Metrics
            m_num_returns:
              label: No. Returns
              type: count_distinct
              group_label: Sales Metrics
              round: 0
              filters:
                - transaction_type: return
            m_return_rate:
              type: number
              label: Return Rate
              group_label: Sales Metrics
              sql: safe_divide(${m_num_returns},${m_num_invoices})
              format: percent
              round: 1
        tests:
          - unique
        data_type: STRING
