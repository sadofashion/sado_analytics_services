version: 2
models:
  - name: fct__revenue_items
    meta:
      joins:
        - join: dim__inventory_items
          sql_on: >-
            ${dim__inventory_items.extended_code} =
            ${fct__revenue_items.product_code} 
        - join: fct__working_days
          sql_on: >-
            ${fct__working_days.date} = ${fct__revenue_items.transaction_date}
            and ${fct__working_days.branch_id} = ${fct__revenue_items.branch_id}
          always: true
    columns:
      - name: branch_id
        description: >-
          This is a numeric identifier that represents the specific branch where
          the transaction took place. It is crucial for understanding the
          performance of different branches and identifying areas for
          improvement.
        meta:
          dimension:
            type: number
            hidden: true
        data_type: NUMERIC
      - name: customer_id
        description: >-
          This is a big numeric identifier that represents a unique customer.
          Can be useful for customer segmentation and personalized marketing.
        meta:
          dimension:
            type: number
            hidden: true
        data_type: BIGNUMERIC
      - name: product_code
        description: >-
          This is a string identifier that represents a unique product. It is
          used to track the sales performance of individual products, which can
          be useful for inventory management and sales forecasting.
        meta:
          dimension:
            type: string
            hidden: true
        data_type: STRING
      - name: transaction_date
        description: >-
          This column represents the date when the transaction occurred. This
          information can be useful for analyzing sales trends over time or
          comparing sales performance across different periods.
        meta:
          dimension:
            type: date
            hidden: true
        data_type: DATE
      - name: transaction_type
        description: >-
          This column indicates the type of transaction that took place. This
          information can be useful for understanding the nature of transactions
          and identifying patterns in sales and returns.
        meta:
          dimension:
            type: string
        data_type: STRING
      - name: price
        description: >-
          The 'price' column represents the original price of the product sold
          in a transaction. This is the price before any discounts are applied.
        meta:
          dimension:
            type: number
            hidden: true
        data_type: FLOAT64
      - name: quantity
        description: >-
          The 'quantity' column indicates the number of units of a product sold
          in a single transaction. This can be used to understand the volume of
          products sold.
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_units_sold:
              type: sum
              label: Units Sold
              group_label: Sales Metrics
              round: 0
              filters:
                - subtotal: "!0"
            m_units_gift:
              type: sum
              label: Units Gift
              group_label: Sales Metrics
              round: 0
              filters:
                - transaction_type: invoice
                - subtotal: "0"
            m_units_exchanged:
              type: sum
              label: Units Exchanged
              group_label: Sales Metrics
              round: 0
              filters:
                - transaction_code: "%HDD%"
            m_units_returned:
              type: sum
              label: Units Returned
              group_label: Sales Metrics
              round: 0
              filters:
                - transaction_type: return
            m_units_returned_pct:
              type: number
              label: Units Returned Pct
              sql: safe_divide(${m_units_returned} , ${m_units_sold})
              format: percent
              round: 2
              group_label: Sales Metrics
            m_net_item_sold:
              type: sum
              label: Net Items Sold
              group_label: Sales Metrics
              round: 0
              filters:
                - subtotal: "!0"
        data_type: NUMERIC
      - name: discount
        description: >-
          The 'discount' column shows the total discount applied to the product
          in a transaction. This is useful for understanding the promotional
          activities and their impact on sales.
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_item_discount:
              type: sum
              label: Item Discount Value
              group_label: Sales Metrics
              compact: millions
              round: 1
              filters:
                - transaction_type: invoice
        data_type: FLOAT64
      - name: subtotal
        description: >-
          The 'subtotal' column represents the total amount of revenue generated
          from a particular transaction after discounts are applied. This
          information is crucial for understanding the gross revenue generated
          from each transaction.
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_total_sold_value:
              type: sum
              label: Total Sold Value
              group_label: Sales Metrics
              compact: millions
              round: 1
              filters:
                - transaction_type: invoice
                - transaction_code: "!%HDD%"
            m_total_retuned_value:
              type: sum
              label: Total Returned Value
              group_label: Sales Metrics
              compact: millions
              round: 1
              filters:
                - transaction_type: return
            m_avg_sold_price:
              type: number
              label: Avg Sold Price
              sql: safe_divide(${m_total_sold_value} - ${m_order_discount}, ${m_units_sold})
              compact: thousands
              round: 2
              group_label: Sales Metrics
            m_item_revenue:
              type: sum
              label: Item Revenue
              group_label: Sales Metrics
              compact: millions
              round: 1
            m_actual_revenue:
              type: sum
              label: Revenue
              group_label: Sales Metrics
              compact: millions
              round: 1
              sql: ${TABLE}.subtotal - coalesce(${TABLE}.order_discount,0)
            m_revenue_psd:
              type: number
              sql: >-
                safe_divide(${m_actual_revenue} ,
                ${fct__working_days.m_operating_days})
              round: 1
              compact: millions
              label: Revenue Per Day
              group_label: Sales Metrics
        data_type: FLOAT64
      - name: revenue_item_id
        description: ""
        meta:
          dimension:
            type: string
            hidden: true
      - name: transaction_id
        description: ""
        meta:
          dimension:
            type: string
            hidden: true
          metrics:
            m_num_transactions:
              type: count_distinct
              label: No. Transactions
              group_label: Sales Metrics
              round: 0
            m_aov:
              type: number
              label: AOV
              group_label: Sales Metrics
              sql: safe_divide(${m_actual_revenue} , ${m_num_invoices})
              compact: thousands 
              round: 1
            m_quantity_per_transaction:
              type: number
              label: Quantity per Transaction
              group_label: Sales Metrics
              sql: safe_divide(${m_units_sold} , ${m_num_invoices})
              round: 2
      - name: product_id
        description: ""
        meta:
          dimension:
            type: number
            hidden: true
      - name: source
        description: ""
        meta:
          dimension:
            type: string
      - name: discount_ratio
        description: ""
        meta:
          dimension:
            type: number
            hidden: true
      - name: cogs
        description: ""
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_total_cogs:
              type: sum
              label: Total COGS
              group_label: Sales Metrics
              compact: millions
              round: 1
            m_gross_margin:
              type: number
              label: Gross Margin
              group_label: Sales Metrics
              sql: >-
                safe_divide(${m_actual_revenue} -${m_total_cogs},
                ${m_actual_revenue})
              format: percent
              round: 2
            m_gross_profit:
              type: number
              label: Gross Profit
              group_label: Sales Metrics
              sql: ${m_actual_revenue} - ${m_total_cogs}
              compact: millions
              round: 1
      - name: order_discount
        description: ""
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            m_order_discount:
              type: sum
              label: Order Discount
              group_label: Sales Metrics
              compact: millions
              round: 1
            m_total_discount:
              type: number
              label: Total Discount
              group_label: Sales Metrics
              sql: ${m_item_discount} + ${m_order_discount}
              compact: millions
              round: 1
            m_avg_dct_per_item:
              type: number
              label: Avg Discount per Unit
              sql: safe_divide(${m_total_discount} , ${m_units_sold})
              compact: thousands
              round: 0
              group_label: Sales Metrics
            m_avg_dct_pct:
              type: number
              label: Avg Discount Pct
              sql: >-
                safe_divide(${m_total_discount} ,
                ${m_total_sold_value}+${m_total_discount})
              format: percent
              round: 2
              group_label: Sales Metrics
      - name: transaction_code
        description: ""
        meta:
          dimension:
            type: string
            hidden: true
          metrics:
            m_num_invoices:
              type: count_distinct
              label: No. Invoices
              group_label: Sales Metrics
              round: 0
              filters:
                - transaction_type: invoice
                - transaction_code: "!%HDD%"
                - subtotal: "!0"
    description: >-
      The fct__revenue_items model merges transaction data from the kiotviet and
      nhanhvn sources, providing details such as branch, customer, product,
      transaction date, type, source, price, quantity, discount, and subtotal.
