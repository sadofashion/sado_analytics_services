version: 2
models:
  - name: rfm_movement
    description: rfm segmentation result
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - customer_id
            - start_of_month
    meta:
      joins:
        - join: stg_kiotviet__customers
          alias: customers
          sql_on: >-
            ${rfm_movement.customer_id} = ${customers.customer_id} and
            ${rfm_movement.start_of_month} = date_trunc(current_date(),month)
          fields:
            - customer_id
            - customer_groups
            - customer_type
            - branch_name
        - join: dim__branches
          sql_on: ${rfm_movement.last_purchase_branch} = ${dim__branches.branch_id}
    columns:
      - name: customer_id
        description: ""
        meta:
          metrics:
            m_num_customers:
              type: count_distinct
              label: Total customers
              group_label: Customer Metrics
              compact: thousands
              round: 1
          dimension:
            type: number
      - name: last_purchase_branch
        description: lastest store customer made purchase
        meta:
          dimension:
            type: number
      - name: start_of_month
        description: month of rfm calculation
        meta:
          dimension:
            type: date
      - name: first_purchase
        description: ""
        meta:
          dimension:
            type: date
        tests:
          - not_null
      - name: last_purchase
        description: ""
        meta:
          dimension:
            type: date
        tests:
          - not_null
      - name: recency
        description: no. days since last purchase
        meta:
          metrics:
            m_med_recency:
              type: median
              label: Med of Recency
              group_label: Customer Metrics
              round: 1
          dimension:
            type: number
      - name: monetary
        description: total monetary value since created
        meta:
          metrics:
            m_monetary:
              type: average
              label: AVG of Monetary
              group_label: Customer Metrics
              compact: thousands
              round: 0
          dimension:
            type: number
      - name: frequency
        description: times of purchasing
        meta:
          metrics:
            m_freq:
              type: average
              label: AVG of Freq
              group_label: Customer Metrics
              round: 1
          dimension:
            type: number
      - name: recency_score
        description: >-
          calculate by dividing customer base into 5 groups by quantile range of
          recency
        meta:
          dimension:
            type: number
            hidden: true
      - name: frequency_score
        description: >-
          calculate by dividing customer base into 5 groups by quantile range of
          frequency
        meta:
          dimension:
            type: number
            hidden: true
      - name: monetary_score
        description: >-
          calculate by dividing customer base into 5 groups by quantile range of
          monetary value
        meta:
          dimension:
            type: number
            hidden: true
      - name: score_concat
        description: rfm concatenated score
        meta:
          dimension:
            type: string
            hidden: true
      - name: segment
        description: group segmentation base on rfm score
        tests:
          - not_null
        meta:
          dimension:
            type: string
      - name: recency_type
        description: classify new and returning customers
        meta:
          dimension:
            type: string
          additional_dimensions:
            d_recency_type:
              type: string
              label: Recency Type (modified)
              sql: >-
                case when ${recency_type} = 'Khách mới' then ${recency_type}
                else 'Khách quay lại' end
      - name: previous_segment
        description: ""
        meta:
          dimension:
            type: string
