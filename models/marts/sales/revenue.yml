version: 2
models:
  - name: revenue
    description: >-
      revenue fact table with single revenue stream per row, excluding
      terminated transaction
    meta:
      joins:
        - join: stg_kiotviet__branches
          sql_on: ${stg_kiotviet__branches.branch_id} = ${revenue.branch_id}
          fields: [branch_name, region, province, branch_id]
        - join: rfm_movement
          sql_on: >-
            ${rfm_movement.customer_id} = ${revenue.customer_id} and
            ${rfm_movement.start_of_month} =
            date_trunc(date(revenue.transaction_date),month)
        - join: stg_kiotviet__customers
          sql_on: ${stg_kiotviet__customers.customer_id} = ${revenue.customer_id}
          fields:
            [
              customer_id,
              customer_groups,
              customer_type,
              m_avg_invoiced,
              m_total_points,
              m_rewarded_points,
              m_avg_revenue,
              m_no_customers,
              m_num_phones,
            ]
        - join: stg_kiotviet__users
          sql_on: ${stg_kiotviet__users.user_id} =${revenue.employee_id}
          fields: [user_id, user_name]
        - join: calendar
          sql_on: ${calendar.date} = date(revenue.transaction_date)
        - join: dim__offline_stores
          sql_on: ${dim__offline_stores.branch_id} = ${revenue.branch_id}
          fields:
            - new_ads_page
            - new_ads_pic
            - asm_name
            - branch_name
            - province
            - region
    columns:
      - name: transaction_id
        description: ""
        meta:
          metrics:
            m_num_transactions:
              type: count_distinct
              label: Number of transactions
              group_label: Sales Metrics
              compact: thousands
              round: 1
            m_num_invoices:
              type: count_distinct
              label: Number of invoices
              group_label: Sales Metrics
              filters:
                - transaction_type: invoice
              compact: thousands
              round: 1
            m_num_returns:
              type: count_distinct
              label: Number of returns
              group_label: Sales Metrics
              filters:
                - transaction_type: return
              compact: thousands
              round: 1
          dimension:
            type: number
      - name: transaction_code
        description: ""
        meta:
          dimension:
            type: string
      - name: transaction_date
        description: ""
        meta:
          dimension:
            type: timestamp
      - name: reference_transaction_id
        description: ""
        meta:
          dimension:
            type: number
      - name: branch_id
        description: ""
        meta:
          metrics:
            m_num_stores:
              type: count_distinct
              label: Number of stores
              group_label: Sales Metrics
            m_no_working_days:
              type: count_distinct
              label: Working days
              group_label: Sales Metrics
              sql: concat(date(${transaction_date}), ${branch_id})
          dimension:
            type: number
      - name: customer_id
        description: ""
        meta:
          metrics:
            m_num_customers:
              type: count_distinct
              label: Number of customers
              group_label: Sales Metrics
              compact: thousands
              round: 1
              filters:
                - transaction_type: invoice
          dimension:
            type: number
      - name: employee_id
        description: ""
        meta:
          dimension:
            type: number
      - name: total
        description: ""
        meta:
          metrics:
            m_total_transaction_value:
              type: sum
              label: Total Transaction Value
              group_label: Sales Metrics
              compact: billions
              round: 1
            m_total_invoice_value:
              type: sum
              label: Total Invoice Value
              group_label: Sales Metrics
              filters:
                - transaction_type: invoice
              compact: billions
              round: 1
            m_total_return_value:
              type: sum
              label: Total Return Value
              group_label: Sales Metrics
              filters:
                - transaction_type: return
              compact: billions
              round: 1
            m_aov:
              type: average
              label: AOV
              group_label: Sales Metrics
              compact: thousands
              round: 0
              filters:
                - transaction_type: invoice
          dimension:
            type: number
      - name: total_payment
        description: ""
        meta:
          metrics:
            total_transaction_payment:
              type: sum
              label: Total Transaction Payment
              group_label: Sales Metrics
              compact: billions
              round: 1
            avg_order_value:
              type: average
              label: Average Transaction Value
              group_label: Sales Metrics
              compact: thousands
              round: 1
          dimension:
            type: number
      - name: discount
        description: ""
        meta:
          metrics:
            discount_value:
              type: sum
              label: Value discount on order
              group_label: Sales Metrics
              compact: millions
              round: 1
          dimension:
            type: number
      - name: discount_ratio
        description: ""
        meta:
          dimension:
            type: number
      - name: return_fee
        description: ""
        meta:
          dimension:
            type: number
      - name: transaction_type
        description: ""
        meta:
          dimension:
            type: string
