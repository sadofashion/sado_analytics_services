version: 2
models:
  - name: revenue
    description: "revenue fact table with single revenue stream per row, excluding terminated transaction"
    meta:
      joins:
        - join: stg_kiotviet__branches
          sql_on: ${stg_kiotviet__branches.branch_id} = ${revenue.branch_id}
        - join: rfm_movement
          sql_on: ${rfm_movement.customer_id} = ${revenue.customer_id} and ${rfm_movement.start_of_month} = date_trunc(date(revenue.transaction_date),month)
        - join: stg_kiotviet__customers
          sql_on: ${stg_kiotviet__customers.customer_id} = ${revenue.customer_id}
        - join: stg_kiotviet__users
          sql_on: ${stg_kiotviet__users.user_id} =${revenue.employee_id}
        - join: calendar
          sql_on: ${calendar.date} = date(revenue.transaction_date)
    columns:
      - name: transaction_id
        description: ""
        meta:
          metrics: 
            m_num_transactions:
              type: count_distinct
              label: "Number of transactions"
              group_label: "Sales Metrics"
              compact: thousands
              round: 1
            m_num_invoices:
              type: count_distinct
              label: "Number of invoices"
              group_label: "Sales Metrics"
              filters:
                - transaction_type: invoice
              compact: thousands
              round: 1
            m_num_returns:
              type: count_distinct
              label: "Number of returns"
              group_label: "Sales Metrics"
              filters:
                - transaction_type: return
              compact: thousands
              round: 1

      - name: transaction_code
        description: ""

      - name: transaction_date
        description: ""

      - name: reference_transaction_id
        description: ""

      - name: branch_id
        description: ""
        meta:
          metrics:
            m_num_stores:
              type: count_distinct
              label: "Number of stores"
              group_label: Sales Metrics
            m_no_working_days:
              type: count_distinct
              label: "Working days"
              group_label: Sales Metrics
              sql: concat(date(${transaction_date}), ${branch_id})

      - name: customer_id
        description: ""
        meta:
          metrics:
            m_num_customers:
              type: count_distinct
              label: "Number of customers"
              group_label: "Sales Metrics"
              compact: thousands
              round: 1
              filters:
                - transaction_type: invoice

      - name: employee_id
        description: ""

      - name: total
        description: ""
        meta:
          metrics:
            m_total_transaction_value:
              type: sum
              label: "Total Transaction Value"
              group_label: "Sales Metrics"
              compact: billions
              round: 1
            m_total_invoice_value:
              type: sum
              label: "Total Invoice Value"
              group_label: "Sales Metrics"
              filters:
                - transaction_type: invoice
              compact: billions
              round: 1
            m_total_return_value:
              type: sum
              label: "Total Return Value"
              group_label: "Sales Metrics"
              filters:
                - transaction_type: return
              compact: billions
              round: 1
            m_aov:
              type: average
              label: "AOV"
              group_label: Sales Metrics
              compact: thousands
              round: 0
              filters:
                - transaction_type: invoice

      - name: total_payment
        description: ""
        meta:
          metrics:
            total_transaction_payment:
              type: sum
              label: "Total Transaction Payment"
              group_label: "Sales Metrics"
              compact: billions
              round: 1
            avg_order_value:
              type: average
              label: Average Transaction Value
              group_label: "Sales Metrics"
              compact: thousands
              round: 1
      - name: discount
        description: ""
        meta:
          metrics:
            discount_value:
              type: sum
              label: Value discount on order
              group_label: Sales Metrics
              compact: millions
              round: 1

      - name: discount_ratio
        description: ""

      - name: return_fee
        description: ""

      - name: transaction_type
        description: ""

semantic_models:
  - name: revenue
    defaults:
      agg_time_dimension: transaction_date
    description: "revenue fact table with single revenue stream per row, excluding terminated transaction"
    model: ref('revenue')
    entities:
      - name: transaction
        expr: transaction_id
        type: primary
      - name: branch
        type: foreign
        expr: branch_id
      - name: customer
        type: foreign
        expr: customer_id
      - name: employee
        type: foreign
        expr: employee_id
    dimensions:
      - name: transaction_date
        expr: date(transaction_date)
        type: time
        type_params:
          time_granularity: day
      - name: transaction_type
        expr: transaction_type
        type: categorical
    measures:
      - name: transaction_count
        description: total number of transaction
        agg: count_distinct
        expr: transaction_id
      - name: total_transaction_value
        description: total value sold
        agg: sum
        expr: total
      - name: received_transaction_value
        description: total revenue received via payments
        agg: sum
        expr: total_payment
      - name: return_fee
        agg: sum
        expr: return_fee
      - name: order_discount
        description: total order discount value
        agg: sum
        expr: discount

metrics:
  - name: gross_revenue
    type: simple
    label: Gross Revenue
    type_params:
      measure: received_transaction_value
  - name: invoice_value
    type: simple
    label: Value Sold
    type_params:
      measure: total_transaction_value
    filter: |
      {{Dimension('transaction__transaction_type')}} = 'invoice'
  - name: invoice_count
    type: simple
    label: No of Invoice
    type_params:
      measure: transaction_count
    filter: |
      {{Dimension('transaction__transaction_type')}} = 'invoice'
  - name: return_count
    type: simple
    label: No of Return
    type_params:
      measure: transaction_count
    filter: |
      {{Dimension('transaction__transaction_type')}} = 'return'
  - name: invoice_paid_value
    type: simple
    label: Paid Value
    type_params:
      measure: received_transaction_value
    filter: |
      {{Dimension('transaction__transaction_type')}} = 'invoice'
  - name: returned_value
    type: simple
    label: Returned Value
    type_params:
      measure: received_transaction_value
    filter: |
      {{Dimension('transaction__transaction_type')}} = 'return'
  - name: order_discounted_value
    type: simple
    label: Order Discounted Value
    type_params:
      measure: order_discount
    filter: |
      {{Dimension('transaction__transaction_type')}} = 'invoice'
  - name: aov
    type: derived
    label: AOV
    type_params:
      expr: invoice_value/invoice_count
      metrics:
        - name: invoice_value
        - name: invoice_count
  - name: pending_invoice
    type: derived
    label: Pending Income Value
    type_params:
      expr: invoice_value - invoice_paid_value
      metrics:
        - name: invoice_value
        - name: invoice_paid_value
  - name: pct_returned
    label: Returned Percentage
    type: derived
    type_params:
      expr: return/invoice
      metrics:
        - name: return_count
          filter: |
            {{Dimension('transaction__transaction_type')}} = 'return'
          alias: return
        - name: invoice_count
          filter: |
            {{Dimension('transaction__transaction_type')}} = 'invoice'
          alias: invoice