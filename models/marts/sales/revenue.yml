models:
  - name: revenue
    description: "revenue fact table with single revenue stream per row, excluding terminated transaction"
    columns:
      - name: transaction_id
        description: ""
        tests:
          - not_nulls
          - unique

      - name: transactioncode
        description: ""

      - name: transaction_date
        description: ""

      - name: referencetransaction_id
        description: ""
        tests:
          - relationships:
              to: ref('revenue')
              field: transaction_id

      - name: branchid
        description: ""
        tests:
          - relationships:
              to: ref('stg_kiotviet__branches')
              field: branchId

      - name: customerid
        description: ""
        tests:
          - relationships:
              to: ref('stg_kiotviet__customers')
              field: customerId

      - name: employeeid
        description: ""
        tests:
          - relationships:
              to: ref('stg_kiotviet__users')
              field: userId

      - name: total
        description: ""

      - name: totalpayment
        description: ""

      - name: discount
        description: ""

      - name: discountratio
        description: ""

      - name: returnfee
        description: ""

      - name: transaction_type
        description: ""

semantic_models:
  - name: orders
    defaults:
      agg_time_dimension: transaction_date
    description: "revenue fact table with single revenue stream per row, excluding terminated transaction"
    model: ref('revenue')
    entities:
      - name: transaction_id
        type: primary
      - name: branch
        type: foreign
        expr: branchId
      - name: customer
        type: foreign
        expr: customerId
      - name: employee
        type: foreign
        expr: employeeId
    dimensions:
      - name: transaction_date
        expr: transaction_date
        type: time
        type_params:
          time_granularity: day
      - name: transaction_type
        expr: transaction_type
        type: categorical
    measures:
      - name: invoice_count
        description: total number of invoices
        agg: count_distinct
        expr: Case when transaction_type = "invoice" then transaction_id end
      - name: return_count
        description: total number of returns
        agg: count_distinct
        expr: case when transaction_type = "return" then transaction_id end
      - name: invoice_value
        description: total value sold
        agg: sum
        expr: case when transaction_type = "invoice" then total end
      - name: return_value
        description: total value returned
        agg: sum
        expr: case when transaction_type = "return" then total end
      - name: median_invoice
        description: median revenue for each invoice
        agg: median
        expr: case when transaction_type = "invoice" then total end
      - name: total_value
        description: total surplus value of all transactions, after discount
        agg: sum
        expr: total
      - name: revenue_received
        description: total revenue received via payments
        agg: sum
        expr: totalPayment
      - name: order_discount_value
        description: total discounted value
        agg: sum
        expr: case when transaction_type ="invoice" then discount end
      - name: return_discounted_value
        description: discounted value on returned
        agg: sum
        expr: case when transaction_type = "return" then discount end
      - name: return_fee
        agg: sum
        expr: returnFee
      - name: invoice_payment
        agg: sum
        expr: case when transaction_type="invoice" then totalPayment end

metrics:
  - name: gross_revenue
    type: simple
    label: Gross Revenue
    type_params:
      measure: revenue_received
  - name: invoice_value
    type: simple
    label: Value Sold
    type_params:
      measure: invoice_value
  - name: invoice_count
    type: simple
    label: No of Invoice
    type_params:
      measure: invoice_count
  - name: invoice_payment
    type: simple
    label: Paid Value
    type_params:
      measure: invoice_payment
  - name: value_returned
    type: simple
    label: Value Returned
    type_params:
      measure: return_value
  - name: aov
    type: derived
    label: AOV
    type_params:
      expr: invoice_value/invoice_count
      metrics:
        - name: invoice_value
        - name: invoice_count
  - name: pending_invoice
    type: derived
    label: Pending Income Value
    type_params:
      expr: invoice_value - invoice_payment
      metrics:
        - name: invoice_value
        - name: invoice_payment